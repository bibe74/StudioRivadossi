USE InVoiceXML;
GO

SELECT * FROM XMLCodifiche.TipoDocumento;
GO

WITH Novita
AS (
    SELECT 'TD16' AS IDTipoDocumento, N'integrazione fattura reverse charge interno' AS TipoDocumento
    UNION ALL SELECT 'TD17', N'integrazione/autofattura per acquisto servizi dall''estero'
    UNION ALL SELECT 'TD18', N'integrazione per acquisto di beni intracomunitari'
    UNION ALL SELECT 'TD19', N'integrazione/autofattura per acquisto di beni ex art.17 c.2 DPR 633/72'
    UNION ALL SELECT 'TD20', N'autofattura per regolarizzazione e integrazione delle fatture (art.6 c.8 d.lgs. 471/97 o art.46 c.5 D.L. 331/93)'
    UNION ALL SELECT 'TD21', N'autofattura per splafonamento TD22 Estrazione beni da Deposito IVA'
    UNION ALL SELECT 'TD23', N'estrazione beni da Deposito IVA con versamento dell''IVA'
    UNION ALL SELECT 'TD24', N'fattura differita di cui all''art.21, comma 4, lett. a)'
    UNION ALL SELECT 'TD25', N'fattura differita di cui all''art.21, comma 4, terzo periodo lett. b)'
    UNION ALL SELECT 'TD26', N'cessione di beni ammortizzabili e per passaggi interni (ex art.36 DPR 633/72)'
    UNION ALL SELECT 'TD27', N'fattura per autoconsumo o per cessioni gratuite senza rivalsa'
)
MERGE INTO XMLCodifiche.TipoDocumento AS DST
USING Novita AS SRC ON SRC.IDTipoDocumento = DST.IDTipoDocumento
WHEN NOT MATCHED THEN INSERT (IDTipoDocumento, TipoDocumento) VALUES (SRC.IDTipoDocumento, SRC.TipoDocumento)
WHEN MATCHED AND DST.TipoDocumento <> SRC.TipoDocumento THEN UPDATE SET DST.TipoDocumento = SRC.TipoDocumento
OUTPUT $action, SRC.IDTipoDocumento, SRC.TipoDocumento;
GO

SELECT * FROM XMLCodifiche.Natura;
GO

ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiCassaPrevidenziale DROP CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DatiCassaPrevidenziale_Natura;
ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiCassaPrevidenziale DROP CONSTRAINT DFT_XMLFatture_FatturaElettronicaBody_DatiCassaPrevidenziale_Natura;
ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiRiepilogo DROP CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DatiRiepilogo_Natura;
ALTER TABLE XMLFatture.FatturaElettronicaBody_DettaglioLinee DROP CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DettaglioLinee_Natura;
ALTER TABLE XMLCodifiche.Natura DROP CONSTRAINT PK_XMLCodifiche_Natura;
GO

ALTER TABLE XMLCodifiche.Natura ALTER COLUMN IDNatura VARCHAR(5) NOT NULL;
ALTER TABLE XMLCodifiche.Natura ADD CONSTRAINT PK_XMLCodifiche_Natura PRIMARY KEY CLUSTERED (IDNatura);
ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiCassaPrevidenziale ALTER COLUMN Natura VARCHAR(5) NOT NULL;
ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiCassaPrevidenziale ADD CONSTRAINT DFT_XMLFatture_FatturaElettronicaBody_DatiCassaPrevidenziale_Natura DEFAULT ('') FOR Natura;
ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiRiepilogo ALTER COLUMN Natura VARCHAR(5) NOT NULL;
ALTER TABLE XMLFatture.FatturaElettronicaBody_DettaglioLinee ALTER COLUMN Natura VARCHAR(5) NOT NULL;
GO

ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiCassaPrevidenziale  WITH CHECK ADD  CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DatiCassaPrevidenziale_Natura FOREIGN KEY(Natura)
REFERENCES XMLCodifiche.Natura (IDNatura)
GO

ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiCassaPrevidenziale CHECK CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DatiCassaPrevidenziale_Natura
GO

ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiRiepilogo  WITH CHECK ADD  CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DatiRiepilogo_Natura FOREIGN KEY(Natura)
REFERENCES XMLCodifiche.Natura (IDNatura)
GO

ALTER TABLE XMLFatture.FatturaElettronicaBody_DatiRiepilogo CHECK CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DatiRiepilogo_Natura
GO

ALTER TABLE XMLFatture.FatturaElettronicaBody_DettaglioLinee  WITH CHECK ADD  CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DettaglioLinee_Natura FOREIGN KEY(Natura)
REFERENCES XMLCodifiche.Natura (IDNatura)
GO

ALTER TABLE XMLFatture.FatturaElettronicaBody_DettaglioLinee CHECK CONSTRAINT FK_XMLFatture_FatturaElettronicaBody_DettaglioLinee_Natura
GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'XMLCodifiche' AND TABLE_NAME = 'Natura' AND COLUMN_NAME = 'IsObsoleta')
BEGIN
    ALTER TABLE XMLCodifiche.Natura ADD IsObsoleta BIT NOT NULL CONSTRAINT DFT_XMLCodifiche_Natura_IsObsoleta DEFAULT (0);
END;
GO

WITH Novita
AS (
    SELECT 'N2.1' AS IDNatura, 'non soggette ad IVA ai sensi degli articoli da 7 a 7- septies del D.P.R. n. 633/1972' AS Natura
    UNION ALL SELECT 'N2.2', 'non soggette - altri casi'
    UNION ALL SELECT 'N3.1', 'non imponibili - esportazioni'
    UNION ALL SELECT 'N3.2', 'non imponibili - cessioni intracomunitarie'
    UNION ALL SELECT 'N3.3', 'non imponibili - cessioni verso San Marino'
    UNION ALL SELECT 'N3.4', 'non imponibili - operazioni assimilate alle cessioni all''esportazione'
    UNION ALL SELECT 'N3.5', 'non imponibili - a seguito di dichiarazioni d''intento'
    UNION ALL SELECT 'N3.6', 'non imponibili - altre operazioni che non concorrono alla formazione del plafond'
    UNION ALL SELECT 'N6.1', 'inversione contabile - cessione di rottami e altri materiali di recupero'
    UNION ALL SELECT 'N6.2', 'inversione contabile - cessione di oro e argento puro'
    UNION ALL SELECT 'N6.3', 'inversione contabile - subappalto nel settore edile'
    UNION ALL SELECT 'N6.4', 'inversione contabile - cessione di fabbricati'
    UNION ALL SELECT 'N6.5', 'inversione contabile - cessione di telefoni cellulari'
    UNION ALL SELECT 'N6.6', 'inversione contabile - cessione di prodotti elettronici'
    UNION ALL SELECT 'N6.7', 'inversione contabile - prestazioni comparto edile e settori connessi'
    UNION ALL SELECT 'N6.8', 'inversione contabile - operazioni settore energetico'
    UNION ALL SELECT 'N6.9', 'inversione contabile - altri casi'
)
MERGE INTO XMLCodifiche.Natura AS DST
USING Novita AS SRC ON SRC.IDNatura = DST.IDNatura
WHEN NOT MATCHED THEN INSERT (IDNatura, Natura) VALUES (SRC.IDNatura, SRC.Natura)
WHEN MATCHED AND DST.Natura <> SRC.Natura THEN UPDATE SET DST.Natura = SRC.Natura
OUTPUT $action, SRC.IDNatura, SRC.Natura;
GO

WITH Deprecate
AS (
    SELECT 'N2' AS IDNatura
    UNION ALL SELECT 'N3'
    UNION ALL SELECT 'N6'
)
UPDATE N
SET N.IsObsoleta = 1
FROM XMLCodifiche.Natura N
INNER JOIN Deprecate D ON D.IDNatura = N.IDNatura;
GO

ALTER TABLE XMLFatture.Staging_FatturaElettronicaBody_DatiCassaPrevidenziale ALTER COLUMN Natura VARCHAR(5) NULL;
GO

ALTER TABLE XMLFatture.Staging_FatturaElettronicaBody_DatiRiepilogo ALTER COLUMN Natura VARCHAR(5) NULL;
GO

ALTER TABLE XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee ALTER COLUMN Natura VARCHAR(5) NULL;
GO

SELECT * FROM XMLCodifiche.TipoRitenuta;
GO

WITH Novita
AS (
    SELECT
        'RT01' AS IDTipoRitenuta,
        N'ritenuta d''acconto (ritenuta persone fisiche)' AS TipoRitenuta
    UNION ALL SELECT 'RT02', N'ritenuta d''acconto (ritenuta persone giuridiche)'
    UNION ALL SELECT 'RT03', N'contributo INPS'
    UNION ALL SELECT 'RT04', N'contributo ENASARCO'
    UNION ALL SELECT 'RT05', N'contributo ENPAM'
    UNION ALL SELECT 'RT06', N'altro contributo previdenziale'
)
MERGE INTO XMLCodifiche.TipoRitenuta AS DST
USING Novita AS SRC ON SRC.IDTipoRitenuta = DST.IDTipoRitenuta
WHEN NOT MATCHED THEN INSERT (IDTipoRitenuta, TipoRitenuta) VALUES (SRC.IDTipoRitenuta, SRC.TipoRitenuta)
WHEN MATCHED AND DST.TipoRitenuta <> SRC.TipoRitenuta THEN UPDATE SET DST.TipoRitenuta = SRC.TipoRitenuta
OUTPUT $action, SRC.IDTipoRitenuta, SRC.TipoRitenuta;
GO

IF NOT EXISTS(SELECT * FROM INFORMATION_SCHEMA.COLUMNS WHERE TABLE_SCHEMA = 'XMLCodifiche' AND TABLE_NAME = 'CausalePagamento' AND COLUMN_NAME = 'IsObsoleta')
BEGIN
    ALTER TABLE XMLCodifiche.CausalePagamento ADD IsObsoleta BIT NOT NULL CONSTRAINT DFT_XMLCodifiche_CausalePagamento_IsObsoleta DEFAULT (0);
END;
GO

WITH Deprecate
AS (
    SELECT 'Z' AS IDCausalePagamento
)
UPDATE N
SET N.IsObsoleta = 1
FROM XMLCodifiche.CausalePagamento N
INNER JOIN Deprecate D ON D.IDCausalePagamento = N.IDCausalePagamento;
GO

WITH Novita
AS (
    SELECT
        N'1.2' AS IDCampo,
        471 AS CodiceErroreSDI,
        N'00471: per i tipi documento TD16, TD17, TD18, TD19, TD20 il cedente/prestatore non può essere uguale al cessionario/committente' AS DescrizioneErroreSDI

    UNION ALL SELECT N'1.2', 472, N'00472: per il tipo documento TD21 il cedente/prestatore deve essere uguale al cessionario/committente'
    UNION ALL SELECT N'1.2', 473, N'00473: per i tipi documento TD17, TD18, TD19 il cedente/prestatore non può avere Codice Paese IT'
    --UNION ALL SELECT N'', 474, N'00474: per il tipo documento TD21 tutte le righe di dettaglio devono avere IVA diversa da zero'
    UNION ALL SELECT N'2.1.1.7.7', 448, N'00448: per le fatture transfrontaliere non è più ammesso il valore generico N2, N3 o N6 come codice natura dell''operazione'
    UNION ALL SELECT N'2.2.1.14', 448, N'00448: per le fatture transfrontaliere non è più ammesso il valore generico N2, N3 o N6 come codice natura dell''operazione'
    UNION ALL SELECT N'2.2.2.2', 448, N'00448: per le fatture transfrontaliere non è più ammesso il valore generico N2, N3 o N6 come codice natura dell''operazione'
    --UNION ALL SELECT N'', 321, N'00321: per le fatture transfrontaliere, in presenza di una partita IVA di gruppo IVA del Cedente/Prestatore occorre valorizzare il Codice Fiscale del Cedente/Prestatore con quello del soggetto partecipante al gruppo'
    --UNION ALL SELECT N'', 325, N'00325: per le fatture transfrontaliere, in presenza di una partita IVA di gruppo IVA del Cessionario/Committente occorre valorizzare il Codice Fiscale del Cessionario/Committente con quello del soggetto partecipante al gruppo'
    UNION ALL SELECT N'2.1.1.5.4', 999, N'00999: non è più ammesso il valore Z come codice pagamento dell''operazione'
)
MERGE INTO XMLCodifiche.CodiceErroreSDI AS DST
USING Novita AS SRC
ON SRC.IDCampo = DST.IDCampo AND SRC.CodiceErroreSDI = DST.CodiceErroreSDI
WHEN NOT MATCHED THEN INSERT (IDCampo, CodiceErroreSDI, DescrizioneErroreSDI) VALUES (SRC.IDCampo, SRC.CodiceErroreSDI, SRC.DescrizioneErroreSDI)
WHEN MATCHED AND DST.DescrizioneErroreSDI <> SRC.DescrizioneErroreSDI THEN UPDATE SET DST.DescrizioneErroreSDI = SRC.DescrizioneErroreSDI
OUTPUT $action, SRC.IDCampo, SRC.CodiceErroreSDI, SRC.DescrizioneErroreSDI;
GO

ALTER PROCEDURE XMLAudit.ssp_ConvalidaFatturaHeader (
	@PKStaging_FatturaElettronicaHeader BIGINT,
	@PKValidazione BIGINT
)
AS
BEGIN

	SET NOCOUNT ON;

	/* declare variables */
	DECLARE @DatiTrasmissione_IdTrasmittente_IdPaese CHAR(2);
	DECLARE @DatiTrasmissione_IdTrasmittente_IdCodice NVARCHAR(28);
	DECLARE @DatiTrasmissione_ProgressivoInvio NVARCHAR(10);
	DECLARE @DatiTrasmissione_FormatoTrasmissione CHAR(5);
	DECLARE @DatiTrasmissione_CodiceDestinatario NVARCHAR(7);
	DECLARE @DatiTrasmissione_PECDestinatario NVARCHAR(256);
	DECLARE @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdPaese CHAR(2);
	DECLARE @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdCodice NVARCHAR(28);
	DECLARE @CedentePrestatore_DatiAnagrafici_CodiceFiscale NVARCHAR(16);
	DECLARE @CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione NVARCHAR(80);
	DECLARE @CedentePrestatore_DatiAnagrafici_Anagrafica_Nome NVARCHAR(60);	
	DECLARE @CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome NVARCHAR(60);	
	DECLARE @CedentePrestatore_DatiAnagrafici_RegimeFiscale CHAR(4);
	DECLARE @CedentePrestatore_Sede_Indirizzo NVARCHAR(60);	
	DECLARE @CedentePrestatore_Sede_NumeroCivico NVARCHAR(8);	
	DECLARE @CedentePrestatore_Sede_CAP CHAR(5);	
	DECLARE @CedentePrestatore_Sede_Comune NVARCHAR(60);	
	DECLARE @CedentePrestatore_Sede_Provincia CHAR(2);
	DECLARE @CedentePrestatore_Sede_Nazione CHAR(2);
	DECLARE @RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdPaese CHAR(2);
	DECLARE @RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdCodice NVARCHAR(28);
	DECLARE @RappresentanteFiscale_DatiAnagrafici_CodiceFiscale NVARCHAR(16);
	DECLARE @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione NVARCHAR(80);	
	DECLARE @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome NVARCHAR(60);	
	DECLARE @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome NVARCHAR(60);	
	DECLARE @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdPaese CHAR(2);
	DECLARE @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdCodice NVARCHAR(28);
	DECLARE @CessionarioCommittente_DatiAnagrafici_CodiceFiscale NVARCHAR(16);
	DECLARE @CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione NVARCHAR(80);	
	DECLARE @CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome NVARCHAR(60);	
	DECLARE @CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome NVARCHAR(60);	
	DECLARE @CessionarioCommittente_Sede_Indirizzo NVARCHAR(60);	
	DECLARE @CessionarioCommittente_Sede_NumeroCivico NVARCHAR(8);	
	DECLARE @CessionarioCommittente_Sede_CAP CHAR(5);	
	DECLARE @CessionarioCommittente_Sede_Comune NVARCHAR(60);
	DECLARE @CessionarioCommittente_Sede_Provincia CHAR(2);
	DECLARE @CessionarioCommittente_Sede_Nazione CHAR(2);
	DECLARE @CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdPaese CHAR(2);
	DECLARE @CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdCodice NVARCHAR(28);
	DECLARE @CessionarioCommittente_RappresentanteFiscale_Denominazione NVARCHAR(80);
	DECLARE @CessionarioCommittente_RappresentanteFiscale_Nome NVARCHAR(60);	
	DECLARE @CessionarioCommittente_RappresentanteFiscale_Cognome NVARCHAR(60);	
	DECLARE @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdPaese CHAR(2);
	DECLARE @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdCodice NVARCHAR(28);
	DECLARE @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_CodiceFiscale NVARCHAR(16);
	DECLARE @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione NVARCHAR(80);
	DECLARE @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome NVARCHAR(60);	
	DECLARE @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome NVARCHAR(60);	
	DECLARE @SoggettoEmittente CHAR(2);

	BEGIN TRY

		DECLARE cursor_FEH CURSOR FAST_FORWARD READ_ONLY FOR
		SELECT
			DatiTrasmissione_IdTrasmittente_IdPaese
			, DatiTrasmissione_IdTrasmittente_IdCodice
			, DatiTrasmissione_ProgressivoInvio
			, DatiTrasmissione_FormatoTrasmissione
			, DatiTrasmissione_CodiceDestinatario
			, DatiTrasmissione_PECDestinatario
			, CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, CedentePrestatore_DatiAnagrafici_CodiceFiscale
			, CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione
			, CedentePrestatore_DatiAnagrafici_Anagrafica_Nome
			, CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome
			, CedentePrestatore_DatiAnagrafici_RegimeFiscale
			, CedentePrestatore_Sede_Indirizzo
			, CedentePrestatore_Sede_NumeroCivico
			, CedentePrestatore_Sede_CAP
			, CedentePrestatore_Sede_Comune
			, CedentePrestatore_Sede_Provincia
			, CedentePrestatore_Sede_Nazione
			, RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, RappresentanteFiscale_DatiAnagrafici_CodiceFiscale
			, RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione
			, RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome
			, RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome
			, CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, CessionarioCommittente_DatiAnagrafici_CodiceFiscale
			, CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione
			, CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome
			, CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome
			, CessionarioCommittente_Sede_Indirizzo
			, CessionarioCommittente_Sede_NumeroCivico
			, CessionarioCommittente_Sede_CAP
			, CessionarioCommittente_Sede_Comune
			, CessionarioCommittente_Sede_Provincia
			, CessionarioCommittente_Sede_Nazione
			, CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdPaese
			, CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdCodice
			, CessionarioCommittente_RappresentanteFiscale_Denominazione
			, CessionarioCommittente_RappresentanteFiscale_Nome
			, CessionarioCommittente_RappresentanteFiscale_Cognome
			, TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_CodiceFiscale
			, TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione
			, TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome
			, TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome
			, SoggettoEmittente
 
		FROM XMLFatture.Staging_FatturaElettronicaHeader
		WHERE PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
		OPEN cursor_FEH;
	
		FETCH NEXT FROM cursor_FEH INTO
			@DatiTrasmissione_IdTrasmittente_IdPaese
			, @DatiTrasmissione_IdTrasmittente_IdCodice
			, @DatiTrasmissione_ProgressivoInvio
			, @DatiTrasmissione_FormatoTrasmissione
			, @DatiTrasmissione_CodiceDestinatario
			, @DatiTrasmissione_PECDestinatario
			, @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, @CedentePrestatore_DatiAnagrafici_CodiceFiscale
			, @CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione
			, @CedentePrestatore_DatiAnagrafici_Anagrafica_Nome
			, @CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome
			, @CedentePrestatore_DatiAnagrafici_RegimeFiscale
			, @CedentePrestatore_Sede_Indirizzo
			, @CedentePrestatore_Sede_NumeroCivico
			, @CedentePrestatore_Sede_CAP
			, @CedentePrestatore_Sede_Comune
			, @CedentePrestatore_Sede_Provincia
			, @CedentePrestatore_Sede_Nazione
			, @RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, @RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, @RappresentanteFiscale_DatiAnagrafici_CodiceFiscale
			, @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione
			, @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome
			, @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome
			, @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, @CessionarioCommittente_DatiAnagrafici_CodiceFiscale
			, @CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione
			, @CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome
			, @CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome
			, @CessionarioCommittente_Sede_Indirizzo
			, @CessionarioCommittente_Sede_NumeroCivico
			, @CessionarioCommittente_Sede_CAP
			, @CessionarioCommittente_Sede_Comune
			, @CessionarioCommittente_Sede_Provincia
			, @CessionarioCommittente_Sede_Nazione
			, @CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdPaese
			, @CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdCodice
			, @CessionarioCommittente_RappresentanteFiscale_Denominazione
			, @CessionarioCommittente_RappresentanteFiscale_Nome
			, @CessionarioCommittente_RappresentanteFiscale_Cognome
			, @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdPaese
			, @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdCodice
			, @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_CodiceFiscale
			, @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione
			, @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome
			, @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome
			, @SoggettoEmittente;

		--WHILE @@FETCH_STATUS = 0
		--BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.1.1.1', @ValoreTesto = @DatiTrasmissione_IdTrasmittente_IdPaese;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.1.1.2', @ValoreTesto = @DatiTrasmissione_IdTrasmittente_IdCodice, @IDNazione = @DatiTrasmissione_IdTrasmittente_IdPaese;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.1.2', @ValoreTesto = @DatiTrasmissione_ProgressivoInvio;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.1.3', @ValoreTesto = @DatiTrasmissione_FormatoTrasmissione;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.1.4', @ValoreTesto = @DatiTrasmissione_CodiceDestinatario, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.1.6', @ValoreTesto = @DatiTrasmissione_PECDestinatario, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.1.1.1', @ValoreTesto = @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdPaese;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.1.1.2', @ValoreTesto = @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdCodice, @IDNazione = @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdPaese;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.1.2', @ValoreTesto = @CedentePrestatore_DatiAnagrafici_CodiceFiscale, @IsObbligatorio = 0, @IDNazione = @CedentePrestatore_DatiAnagrafici_IdFiscaleIVA_IdPaese;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.1.3.1', @ValoreTesto = @CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.1.3.2', @ValoreTesto = @CedentePrestatore_DatiAnagrafici_Anagrafica_Nome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.1.3.3', @ValoreTesto = @CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.1.8', @ValoreTesto = @CedentePrestatore_DatiAnagrafici_RegimeFiscale;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.2.1', @ValoreTesto = @CedentePrestatore_Sede_Indirizzo;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.2.2', @ValoreTesto = @CedentePrestatore_Sede_NumeroCivico, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.2.3', @ValoreTesto = @CedentePrestatore_Sede_CAP;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.2.4', @ValoreTesto = @CedentePrestatore_Sede_Comune;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.2.5', @ValoreTesto = @CedentePrestatore_Sede_Provincia, @IsObbligatorio = 0, @IDNazione = @CedentePrestatore_Sede_Nazione;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.2.2.6', @ValoreTesto = @CedentePrestatore_Sede_Nazione;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.3.1.1.1', @ValoreTesto = @RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdPaese, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.3.1.1.2', @ValoreTesto = @RappresentanteFiscale_DatiAnagrafici_IdFiscaleIVA_IdCodice, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.3.1.2', @ValoreTesto = @RappresentanteFiscale_DatiAnagrafici_CodiceFiscale, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.3.1.3.1', @ValoreTesto = @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.3.1.3.2', @ValoreTesto = @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.3.1.3.3', @ValoreTesto = @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.1.1.1', @ValoreTesto = @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdPaese, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.1.1.2', @ValoreTesto = @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdCodice, @IsObbligatorio = 0, @IDNazione = @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdPaese;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.1.2', @ValoreTesto = @CessionarioCommittente_DatiAnagrafici_CodiceFiscale, @IsObbligatorio = 0, @IDNazione = @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdPaese;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.1.3.1', @ValoreTesto = @CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.1.3.2', @ValoreTesto = @CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.1.3.3', @ValoreTesto = @CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.2.1', @ValoreTesto = @CessionarioCommittente_Sede_Indirizzo;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.2.2', @ValoreTesto = @CessionarioCommittente_Sede_NumeroCivico, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.2.3', @ValoreTesto = @CessionarioCommittente_Sede_CAP;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.2.4', @ValoreTesto = @CessionarioCommittente_Sede_Comune;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.2.5', @ValoreTesto = @CessionarioCommittente_Sede_Provincia, @IsObbligatorio = 0, @IDNazione = @CessionarioCommittente_Sede_Nazione;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.2.6', @ValoreTesto = @CessionarioCommittente_Sede_Nazione;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.4.1.1', @ValoreTesto = @CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdPaese, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.4.1.2', @ValoreTesto = @CessionarioCommittente_RappresentanteFiscale_IdFiscaleIVA_IdCodice, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.4.2', @ValoreTesto = @CessionarioCommittente_RappresentanteFiscale_Denominazione, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.4.3', @ValoreTesto = @CessionarioCommittente_RappresentanteFiscale_Nome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.4.4.4', @ValoreTesto = @CessionarioCommittente_RappresentanteFiscale_Cognome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.5.1.1.1', @ValoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdPaese, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.5.1.1.2', @ValoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_IdFiscaleIVA_IdCodice, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.5.1.2', @ValoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_CodiceFiscale, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.5.1.3.1', @ValoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.5.1.3.2', @ValoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.5.1.3.3', @ValoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'1.6', @ValoreTesto = @SoggettoEmittente, @IsObbligatorio = 0;

		IF (
			(@DatiTrasmissione_FormatoTrasmissione = 'FPA12' AND LEN(@DatiTrasmissione_CodiceDestinatario) <> 6)
			OR (@DatiTrasmissione_FormatoTrasmissione = 'FPR12' AND LEN(@DatiTrasmissione_CodiceDestinatario) <> 7)
		)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'1.1.3',
																@CodiceErroreSDI = 427,
																@valoreTesto = @DatiTrasmissione_FormatoTrasmissione,
																@LivelloLog = 4;

		END;

		IF (
			(@DatiTrasmissione_FormatoTrasmissione = 'FPA12' AND LEN(@DatiTrasmissione_CodiceDestinatario) <> 6)
			OR (@DatiTrasmissione_FormatoTrasmissione = 'FPR12' AND LEN(@DatiTrasmissione_CodiceDestinatario) <> 7)
		)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'1.1.4',
																@CodiceErroreSDI = 427,
																@valoreTesto = @DatiTrasmissione_CodiceDestinatario,
																@LivelloLog = 4;

		END;

		IF (
			/* Specifica Versione 1.2.1 - 1.1.6 <PECDestinatario> non valorizzato a fronte di 1.1.4 <CodiceDestinatario> con valore 0000000
            (@DatiTrasmissione_FormatoTrasmissione = 'FPR12' AND @DatiTrasmissione_CodiceDestinatario = N'0000000' AND COALESCE(@DatiTrasmissione_PECDestinatario, N'') = N'')
			OR (@DatiTrasmissione_FormatoTrasmissione = 'FPR12' AND @DatiTrasmissione_CodiceDestinatario <> N'0000000' AND COALESCE(@DatiTrasmissione_PECDestinatario, N'') <> N'') 
            
            In realtà lo SDI accetta fatture con CodiceDestinatario 0000000 e PEC non valorizzata (OK per i privati senza codice destinatario nè PEC) */
			(@DatiTrasmissione_FormatoTrasmissione = 'FPR12' AND @DatiTrasmissione_CodiceDestinatario <> N'0000000' AND COALESCE(@DatiTrasmissione_PECDestinatario, N'') <> N'')
		)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'1.1.6',
																@CodiceErroreSDI = 426,
																@valoreTesto = @DatiTrasmissione_PECDestinatario,
																@LivelloLog = 4;

		END;


		----IF (
		----	COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N''
		----	OR COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''
		----	OR COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Nome, N'') <> N''
		----)
		----BEGIN

			IF (
				(COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND (COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Nome, N'') = N'' OR COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome, N'') = N''))
				OR (COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND (COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Nome, N'') <> N'' OR COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''))
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.2.1.3.1',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome, N'') = N'')
				OR (COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.2.1.3.2',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CedentePrestatore_DatiAnagrafici_Anagrafica_Cognome,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Nome, N'') = N'')
				OR (COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@CedentePrestatore_DatiAnagrafici_Anagrafica_Nome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.2.1.3.3',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CedentePrestatore_DatiAnagrafici_Anagrafica_Nome,
																	@LivelloLog = 4;

			END;

		----END;

		IF (
			COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N''
			OR COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''
			OR COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome, N'') <> N''
		)
		BEGIN

			IF (
				(COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND (COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome, N'') = N'' OR COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome, N'') = N''))
				OR (COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND (COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome, N'') <> N'' OR COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''))
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.3.1.3.1',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome, N'') = N'')
				OR (COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.3.1.3.2',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Cognome,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome, N'') = N'')
				OR (COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.3.1.3.3',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @RappresentanteFiscale_DatiAnagrafici_Anagrafica_Nome,
																	@LivelloLog = 4;

			END;

		END;

		IF (
			COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N''
			OR COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''
			OR COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome, N'') <> N''
		)
		BEGIN

			IF (COALESCE(@CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdCodice, N'') = N'' AND COALESCE(@CessionarioCommittente_DatiAnagrafici_CodiceFiscale, N'') = N'')
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.1.1',
																	@CodiceErroreSDI = 417,
																	@valoreTesto = @CessionarioCommittente_DatiAnagrafici_IdFiscaleIVA_IdCodice,
																	@LivelloLog = 4;

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.1.2',
																	@CodiceErroreSDI = 417,
																	@valoreTesto = @CessionarioCommittente_DatiAnagrafici_CodiceFiscale,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND (COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome, N'') = N'' OR COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome, N'') = N''))
				OR (COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND (COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome, N'') <> N'' OR COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''))
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.1.3.1',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome, N'') = N'')
				OR (COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.1.3.2',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CessionarioCommittente_DatiAnagrafici_Anagrafica_Cognome,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome, N'') = N'')
				OR (COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.1.3.3',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CessionarioCommittente_DatiAnagrafici_Anagrafica_Nome,
																	@LivelloLog = 4;

			END;

		END;

		IF (
			COALESCE(@CessionarioCommittente_RappresentanteFiscale_Denominazione, N'') <> N''
			OR COALESCE(@CessionarioCommittente_RappresentanteFiscale_Cognome, N'') <> N''
			OR COALESCE(@CessionarioCommittente_RappresentanteFiscale_Nome, N'') <> N''
		)
		BEGIN

			IF (
				(COALESCE(@CessionarioCommittente_RappresentanteFiscale_Denominazione, N'') = N'' AND (COALESCE(@CessionarioCommittente_RappresentanteFiscale_Nome, N'') = N'' OR COALESCE(@CessionarioCommittente_RappresentanteFiscale_Cognome, N'') = N''))
				OR (COALESCE(@CessionarioCommittente_RappresentanteFiscale_Denominazione, N'') <> N'' AND (COALESCE(@CessionarioCommittente_RappresentanteFiscale_Nome, N'') <> N'' OR COALESCE(@CessionarioCommittente_RappresentanteFiscale_Cognome, N'') <> N''))
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.4.3',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CessionarioCommittente_RappresentanteFiscale_Denominazione,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@CessionarioCommittente_RappresentanteFiscale_Denominazione, N'') = N'' AND COALESCE(@CessionarioCommittente_RappresentanteFiscale_Cognome, N'') = N'')
				OR (COALESCE(@CessionarioCommittente_RappresentanteFiscale_Denominazione, N'') <> N'' AND COALESCE(@CessionarioCommittente_RappresentanteFiscale_Cognome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.4.3',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CessionarioCommittente_RappresentanteFiscale_Cognome,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@CessionarioCommittente_RappresentanteFiscale_Denominazione, N'') = N'' AND COALESCE(@CessionarioCommittente_RappresentanteFiscale_Nome, N'') = N'')
				OR (COALESCE(@CessionarioCommittente_RappresentanteFiscale_Denominazione, N'') <> N'' AND COALESCE(@CessionarioCommittente_RappresentanteFiscale_Nome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.4.4.4',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @CessionarioCommittente_RappresentanteFiscale_Nome,
																	@LivelloLog = 4;

			END;

		END;

		IF (
			COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N''
			OR COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''
			OR COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome, N'') <> N''
		)
		BEGIN

			IF (
				(COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND (COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome, N'') = N'' OR COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome, N'') = N''))
				OR (COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND (COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome, N'') <> N'' OR COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome, N'') <> N''))
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.5.1.3.1',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome, N'') = N'')
				OR (COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.5.1.3.2',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Cognome,
																	@LivelloLog = 4;

			END;

			IF (
				(COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, N'') = N'' AND COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome, N'') = N'')
				OR (COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Denominazione, N'') <> N'' AND COALESCE(@TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome, N'') <> N'')
			)
			BEGIN

				EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																	@IDCampo = N'1.5.1.3.3',
																	@CodiceErroreSDI = 200,
																	@valoreTesto = @TerzoIntermediarioOSoggettoEmittente_DatiAnagrafici_Anagrafica_Nome,
																	@LivelloLog = 4;

			END;

		END;

		--    FETCH NEXT FROM cursor_FEH INTO @variable
		--END
	
		CLOSE cursor_FEH;
		DEALLOCATE cursor_FEH;

	END TRY
	BEGIN CATCH

	END CATCH

END;
GO

ALTER PROCEDURE XMLAudit.ssp_ConvalidaFatturaBody (
	@PKStaging_FatturaElettronicaHeader BIGINT,
	@PKValidazione BIGINT
)
AS
BEGIN

	SET NOCOUNT ON;

	/* declare variables */
	DECLARE @DatiGenerali_DatiGeneraliDocumento_TipoDocumento CHAR(4);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_Divisa CHAR(3);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_Data DATE;
	DECLARE @DatiGenerali_DatiGeneraliDocumento_Numero NVARCHAR(20);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta CHAR(4);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_ImportoRitenuta DECIMAL(14,2);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_AliquotaRitenuta DECIMAL(5,2);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_CausalePagamento CHAR(2);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_DatiBollo_BolloVirtuale CHAR(2);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_DatiBollo_ImportoBollo DECIMAL(14,2);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_ImportoTotaleDocumento DECIMAL(14,2);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_Arrotondamento DECIMAL(14,2);
	DECLARE @DatiGenerali_DatiGeneraliDocumento_Art73 CHAR(2);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdPaese CHAR(2);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdCodice NVARCHAR(28);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_CodiceFiscale NVARCHAR(16);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Denominazione NVARCHAR(80);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Nome NVARCHAR(60);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Cognome NVARCHAR(60);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Titolo NVARCHAR(10);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_CodEORI NVARCHAR(17);
	DECLARE @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_NumeroLicenzaGuida NVARCHAR(20);
	DECLARE @DatiGenerali_DatiTrasporto_MezzoTrasporto NVARCHAR(80);
	DECLARE @DatiGenerali_DatiTrasporto_CausaleTrasporto NVARCHAR(100);
	DECLARE @DatiGenerali_DatiTrasporto_NumeroColli INT;
	DECLARE @DatiGenerali_DatiTrasporto_Descrizione NVARCHAR(100);
	DECLARE @DatiGenerali_DatiTrasporto_UnitaMisuraPeso NVARCHAR(10);
	DECLARE @DatiGenerali_DatiTrasporto_PesoLordo DECIMAL(6,2);
	DECLARE @DatiGenerali_DatiTrasporto_PesoNetto DECIMAL(6,2);
	DECLARE @DatiGenerali_DatiTrasporto_DataOraRitiro DATETIME;
	DECLARE @DatiGenerali_DatiTrasporto_DataInizioTrasporto DATE;
	DECLARE @DatiGenerali_DatiTrasporto_TipoResa CHAR(3);
	DECLARE @DatiGenerali_DatiTrasporto_IndirizzoResa_Indirizzo NVARCHAR(60);
	DECLARE @DatiGenerali_DatiTrasporto_IndirizzoResa_NumeroCivico NVARCHAR(8);
	DECLARE @DatiGenerali_DatiTrasporto_IndirizzoResa_CAP CHAR(5);
	DECLARE @DatiGenerali_DatiTrasporto_IndirizzoResa_Comune NVARCHAR(60);
	DECLARE @DatiGenerali_DatiTrasporto_IndirizzoResa_Provincia CHAR(2);
	DECLARE @DatiGenerali_DatiTrasporto_IndirizzoResa_Nazione CHAR(2);
	DECLARE @DatiGenerali_DatiTrasporto_DataOraConsegna DATETIME;
	DECLARE @DatiGenerali_FatturaPrincipale_NumeroFatturaPrincipale NVARCHAR(20);
	DECLARE @DatiGenerali_FatturaPrincipale_DataFatturaPrincipale DATE;
	DECLARE @DatiVeicoli_Data DATE;
	DECLARE @DatiVeicoli_TotalePercorso NVARCHAR(15);

	DECLARE cursor_FEB CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        DatiGenerali_DatiGeneraliDocumento_TipoDocumento,
        DatiGenerali_DatiGeneraliDocumento_Divisa,
        DatiGenerali_DatiGeneraliDocumento_Data,
        DatiGenerali_DatiGeneraliDocumento_Numero,
        DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta,
        DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_ImportoRitenuta,
        DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_AliquotaRitenuta,
        DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_CausalePagamento,
        DatiGenerali_DatiGeneraliDocumento_DatiBollo_BolloVirtuale,
        DatiGenerali_DatiGeneraliDocumento_DatiBollo_ImportoBollo,
        DatiGenerali_DatiGeneraliDocumento_ImportoTotaleDocumento,
        DatiGenerali_DatiGeneraliDocumento_Arrotondamento,
        DatiGenerali_DatiGeneraliDocumento_Art73,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdPaese,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdCodice,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_CodiceFiscale,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Denominazione,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Nome,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Cognome,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Titolo,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_CodEORI,
        DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_NumeroLicenzaGuida,
        DatiGenerali_DatiTrasporto_MezzoTrasporto,
        DatiGenerali_DatiTrasporto_CausaleTrasporto,
        DatiGenerali_DatiTrasporto_NumeroColli,
        DatiGenerali_DatiTrasporto_Descrizione,
        DatiGenerali_DatiTrasporto_UnitaMisuraPeso,
        DatiGenerali_DatiTrasporto_PesoLordo,
        DatiGenerali_DatiTrasporto_PesoNetto,
        DatiGenerali_DatiTrasporto_DataOraRitiro,
        DatiGenerali_DatiTrasporto_DataInizioTrasporto,
        DatiGenerali_DatiTrasporto_TipoResa,
        DatiGenerali_DatiTrasporto_IndirizzoResa_Indirizzo,
        DatiGenerali_DatiTrasporto_IndirizzoResa_NumeroCivico,
        DatiGenerali_DatiTrasporto_IndirizzoResa_CAP,
        DatiGenerali_DatiTrasporto_IndirizzoResa_Comune,
        DatiGenerali_DatiTrasporto_IndirizzoResa_Provincia,
        DatiGenerali_DatiTrasporto_IndirizzoResa_Nazione,
        DatiGenerali_DatiTrasporto_DataOraConsegna,
        DatiGenerali_FatturaPrincipale_NumeroFatturaPrincipale,
        DatiGenerali_FatturaPrincipale_DataFatturaPrincipale,
        DatiVeicoli_Data,
        DatiVeicoli_TotalePercorso
 
	FROM XMLFatture.Staging_FatturaElettronicaBody
	WHERE PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEB;
	
	FETCH NEXT FROM cursor_FEB INTO
		@DatiGenerali_DatiGeneraliDocumento_TipoDocumento
		, @DatiGenerali_DatiGeneraliDocumento_Divisa
		, @DatiGenerali_DatiGeneraliDocumento_Data
		, @DatiGenerali_DatiGeneraliDocumento_Numero
		, @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta
		, @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_ImportoRitenuta
		, @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_AliquotaRitenuta
		, @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_CausalePagamento
		, @DatiGenerali_DatiGeneraliDocumento_DatiBollo_BolloVirtuale
		, @DatiGenerali_DatiGeneraliDocumento_DatiBollo_ImportoBollo
		, @DatiGenerali_DatiGeneraliDocumento_ImportoTotaleDocumento
		, @DatiGenerali_DatiGeneraliDocumento_Arrotondamento
		, @DatiGenerali_DatiGeneraliDocumento_Art73
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdPaese
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdCodice
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_CodiceFiscale
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Denominazione
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Nome
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Cognome
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Titolo
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_CodEORI
		, @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_NumeroLicenzaGuida
		, @DatiGenerali_DatiTrasporto_MezzoTrasporto
		, @DatiGenerali_DatiTrasporto_CausaleTrasporto
		, @DatiGenerali_DatiTrasporto_NumeroColli
		, @DatiGenerali_DatiTrasporto_Descrizione
		, @DatiGenerali_DatiTrasporto_UnitaMisuraPeso
		, @DatiGenerali_DatiTrasporto_PesoLordo
		, @DatiGenerali_DatiTrasporto_PesoNetto
		, @DatiGenerali_DatiTrasporto_DataOraRitiro
		, @DatiGenerali_DatiTrasporto_DataInizioTrasporto
		, @DatiGenerali_DatiTrasporto_TipoResa
		, @DatiGenerali_DatiTrasporto_IndirizzoResa_Indirizzo
		, @DatiGenerali_DatiTrasporto_IndirizzoResa_NumeroCivico
		, @DatiGenerali_DatiTrasporto_IndirizzoResa_CAP
		, @DatiGenerali_DatiTrasporto_IndirizzoResa_Comune
		, @DatiGenerali_DatiTrasporto_IndirizzoResa_Provincia
		, @DatiGenerali_DatiTrasporto_IndirizzoResa_Nazione
		, @DatiGenerali_DatiTrasporto_DataOraConsegna
		, @DatiGenerali_FatturaPrincipale_NumeroFatturaPrincipale
		, @DatiGenerali_FatturaPrincipale_DataFatturaPrincipale
		, @DatiVeicoli_Data
		, @DatiVeicoli_TotalePercorso;

	--WHILE @@FETCH_STATUS = 0
	--BEGIN
	    
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.1', @ValoreTesto = @DatiGenerali_DatiGeneraliDocumento_TipoDocumento;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.2', @ValoreTesto = @DatiGenerali_DatiGeneraliDocumento_Divisa;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.3', @TipoValore = 'E', @ValoreData = @DatiGenerali_DatiGeneraliDocumento_Data;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.4', @ValoreTesto = @DatiGenerali_DatiGeneraliDocumento_Numero;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.5.1', @ValoreTesto = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.5.2', @TipoValore = 'D', @ValoreDecimale = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_ImportoRitenuta, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.5.3', @TipoValore = 'D', @ValoreDecimale = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_AliquotaRitenuta, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.5.4', @ValoreTesto = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_CausalePagamento, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.6.1', @ValoreTesto = @DatiGenerali_DatiGeneraliDocumento_DatiBollo_BolloVirtuale, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.6.2', @TipoValore = 'D', @ValoreDecimale = @DatiGenerali_DatiGeneraliDocumento_DatiBollo_ImportoBollo, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.9', @TipoValore = 'D', @ValoreDecimale = @DatiGenerali_DatiGeneraliDocumento_ImportoTotaleDocumento, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.10', @TipoValore = 'D', @ValoreDecimale = @DatiGenerali_DatiGeneraliDocumento_Arrotondamento, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.12', @ValoreTesto = @DatiGenerali_DatiGeneraliDocumento_Art73, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.1.1', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdPaese, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.1.2', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_IdFiscaleIVA_IdCodice, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.2', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_CodiceFiscale, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.3.1', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Denominazione, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.3.2', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Nome, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.3.3', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Cognome, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.3.4', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_Titolo, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.3.5', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_Anagrafica_CodEORI, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.1.4', @ValoreTesto = @DatiGenerali_DatiTrasporto_DatiAnagraficiVettore_NumeroLicenzaGuida, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.2', @ValoreTesto = @DatiGenerali_DatiTrasporto_MezzoTrasporto, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.3', @ValoreTesto = @DatiGenerali_DatiTrasporto_CausaleTrasporto, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.4', @TipoValore = 'I', @ValoreIntero = @DatiGenerali_DatiTrasporto_NumeroColli, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.5', @ValoreTesto = @DatiGenerali_DatiTrasporto_Descrizione, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.6', @ValoreTesto = @DatiGenerali_DatiTrasporto_UnitaMisuraPeso, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.7', @ValoreTesto = @DatiGenerali_DatiTrasporto_PesoLordo, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.8', @ValoreTesto = @DatiGenerali_DatiTrasporto_PesoNetto, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.9', @TipoValore = 'E', @ValoreData = @DatiGenerali_DatiTrasporto_DataOraRitiro, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.10', @TipoValore = 'E', @ValoreData = @DatiGenerali_DatiTrasporto_DataInizioTrasporto, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.11', @ValoreTesto = @DatiGenerali_DatiTrasporto_TipoResa, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.12.1', @ValoreTesto = @DatiGenerali_DatiTrasporto_IndirizzoResa_Indirizzo, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.12.2', @ValoreTesto = @DatiGenerali_DatiTrasporto_IndirizzoResa_NumeroCivico, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.12.3', @ValoreTesto = @DatiGenerali_DatiTrasporto_IndirizzoResa_CAP, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.12.4', @ValoreTesto = @DatiGenerali_DatiTrasporto_IndirizzoResa_Comune, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.12.5', @ValoreTesto = @DatiGenerali_DatiTrasporto_IndirizzoResa_Provincia, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.12.6', @ValoreTesto = @DatiGenerali_DatiTrasporto_IndirizzoResa_Nazione, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.9.13', @TipoValore = 'E', @ValoreData = @DatiGenerali_DatiTrasporto_DataOraConsegna, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.10.1', @ValoreTesto = @DatiGenerali_FatturaPrincipale_NumeroFatturaPrincipale, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.10.2', @TipoValore = 'E', @ValoreData = @DatiGenerali_FatturaPrincipale_DataFatturaPrincipale, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.3.1', @ValoreTesto = @DatiVeicoli_Data, @IsObbligatorio = 0;
	EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.3.2', @ValoreTesto = @DatiVeicoli_TotalePercorso, @IsObbligatorio = 0;

	IF (@DatiGenerali_DatiGeneraliDocumento_Data > CAST(CURRENT_TIMESTAMP AS DATE))
	BEGIN

		EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
						                                  @IDCampo = N'2.1.1.3',
						                                  @CodiceErroreSDI = 403,
						                                  @valoreData = @DatiGenerali_DatiGeneraliDocumento_Data,
						                                  @LivelloLog = 4;

	END;

	IF (@DatiGenerali_DatiGeneraliDocumento_TipoDocumento = 'TD04')
	BEGIN

		DECLARE @DataPrimaFatturaCollegata DATE;

		SELECT
			@DataPrimaFatturaCollegata = MIN(FEBDDC.[Data])
		
		FROM XMLFatture.Staging_FatturaElettronicaBody_DocumentoEsterno FEBDDC
		INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDDC.PKStaging_FatturaElettronicaBody
			AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader
		WHERE FEBDDC.TipoDocumentoEsterno = N'FTCL';

		IF (@DatiGenerali_DatiGeneraliDocumento_Data < @DataPrimaFatturaCollegata)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
															  @IDCampo = N'2.1.1.3',
															  @CodiceErroreSDI = 418,
															  @valoreData = @DatiGenerali_DatiGeneraliDocumento_Data,
															  @LivelloLog = 4;
		END;

	END;

	IF (@DatiGenerali_DatiGeneraliDocumento_Numero NOT LIKE N'%[0-9]%')
	BEGIN

		EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
						                                  @IDCampo = N'2.1.1.4',
						                                  @CodiceErroreSDI = 425,
						                                  @valoreTesto = @DatiGenerali_DatiGeneraliDocumento_Numero,
						                                  @LivelloLog = 4;

	END;

	IF (
		@DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta = N''
		AND EXISTS(
			SELECT FEBDL.Ritenuta
			FROM XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee FEBDL
			INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDL.PKStaging_FatturaElettronicaBody
				AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader
			WHERE FEBDL.Ritenuta = 'SI'
		)
	)
	BEGIN

		EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
						                                  @IDCampo = N'2.1.1.5',
						                                  @CodiceErroreSDI = 411,
						                                  @valoreTesto = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta,
						                                  @LivelloLog = 4;

	END;

	IF (
		@DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta = N''
		AND EXISTS(
			SELECT FEBDCP.Ritenuta
			FROM XMLFatture.Staging_FatturaElettronicaBody_DatiCassaPrevidenziale FEBDCP
			INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDCP.PKStaging_FatturaElettronicaBody
				AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader
			WHERE FEBDCP.Ritenuta = 'SI'
		)
	)
	BEGIN

		EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
						                                  @IDCampo = N'2.1.1.5',
						                                  @CodiceErroreSDI = 415,
						                                  @valoreTesto = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_TipoRitenuta,
						                                  @LivelloLog = 4;

	END;

    IF (@DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_CausalePagamento <> N'')
    BEGIN

        DECLARE @IsCausalePagamentoObsoleta BIT;
	    SELECT @IsCausalePagamentoObsoleta = IsObsoleta FROM XMLCodifiche.CausalePagamento WHERE IDCausalePagamento = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_CausalePagamento;
        IF (@IsCausalePagamentoObsoleta = CAST(1 AS BIT))
        BEGIN

		    EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
															    @IDCampo = N'2.1.1.5.4',
															    @CodiceErroreSDI = 999,
															    @valoreTesto = @DatiGenerali_DatiGeneraliDocumento_DatiRitenuta_CausalePagamento,
															    @LivelloLog = 4;

        END;

    END;
    SELECT * FROM XMLCodifiche.CodiceErroreSDI WHERE CodiceErroreSDI = 448
	--    FETCH NEXT FROM cursor_FEH INTO @variable
	--END;

	/*** Causale: inizio ***/

	/* declare variables */
	DECLARE @DatiGenerali_Causale NVARCHAR(200);
	
	DECLARE cursor_FEBC CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBC.DatiGenerali_Causale
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_Causale FEBC
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBC.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBC
	
	FETCH NEXT FROM cursor_FEBC INTO @DatiGenerali_Causale;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.11', @ValoreTesto = @DatiGenerali_Causale, @IsObbligatorio = 0;
	
	    FETCH NEXT FROM cursor_FEBC INTO @DatiGenerali_Causale;
	END
	
	CLOSE cursor_FEBC
	DEALLOCATE cursor_FEBC

	/*** Causale: fine ***/

	/*** DatiDDT: inizio ***/

	/* declare variables */
	DECLARE @NumeroDDT NVARCHAR(20);
	DECLARE @DataDDT DATE;
	
	DECLARE cursor_FEBDDDT CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDDDT.NumeroDDT,
        FEBDDDT.DataDDT
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DatiDDT FEBDDDT
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDDDT.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBDDDT
	
	FETCH NEXT FROM cursor_FEBDDDT INTO @NumeroDDT, @DataDDT;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.8.1', @ValoreTesto = @NumeroDDT;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.8,2', @TipoValore = 'E', @ValoreData = @DataDDT;
	
		FETCH NEXT FROM cursor_FEBDDDT INTO @NumeroDDT, @DataDDT;
	END
	
	CLOSE cursor_FEBDDDT
	DEALLOCATE cursor_FEBDDDT

	/*** DatiDDT: fine ***/
	
	/*** DatiDDT_RiferimentoNumeroLinea: inizio ***/

	/* declare variables */
	DECLARE @RiferimentoNumeroLinea INT;
	
	DECLARE cursor_FEBDDDTNL CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDDDTNL.RiferimentoNumeroLinea
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DatiDDT_RiferimentoNumeroLinea FEBDDDTNL
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody_DatiDDT FEBDDDT ON FEBDDDT.PKStaging_FatturaElettronicaBody_DatiDDT = FEBDDDTNL.PKStaging_FatturaElettronicaBody_DatiDDT
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDDDT.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBDDDTNL
	
	FETCH NEXT FROM cursor_FEBDDDTNL INTO @RiferimentoNumeroLinea;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.1.1.11', @TipoValore = 'I', @ValoreIntero = @RiferimentoNumeroLinea;
	
		FETCH NEXT FROM cursor_FEBDDDTNL INTO @RiferimentoNumeroLinea;
	END
	
	CLOSE cursor_FEBDDDTNL
	DEALLOCATE cursor_FEBDDDTNL

	/*** DatiDDT: fine ***/

	/*** DettaglioLinee: inizio ***/

	/* declare variables */
	DECLARE @NumeroLinea INT;
	DECLARE @TipoCessionePrestazione CHAR(2);
	DECLARE @Descrizione NVARCHAR(1000);
	DECLARE @Quantita DECIMAL(20, 5);
	DECLARE @UnitaMisura NVARCHAR(10);
	DECLARE @DataInizioPeriodo DATE;
	DECLARE @DataFinePeriodo DATE;
	DECLARE @PrezzoUnitario DECIMAL(20, 5);
	DECLARE @PrezzoTotale DECIMAL(20, 5);
	DECLARE @AliquotaIVA DECIMAL(5, 2);
	DECLARE @Ritenuta CHAR(2);
	DECLARE @Natura VARCHAR(5);
    DECLARE @IsNaturaObsoleta BIT;
	DECLARE @RiferimentoAmministrazione NVARCHAR(20);
	
	DECLARE cursor_FEBDL CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDL.NumeroLinea,
        FEBDL.TipoCessionePrestazione,
        FEBDL.Descrizione,
        FEBDL.Quantita,
        FEBDL.UnitaMisura,
        FEBDL.DataInizioPeriodo,
        FEBDL.DataFinePeriodo,
        FEBDL.PrezzoUnitario,
        FEBDL.PrezzoTotale,
        FEBDL.AliquotaIVA,
        FEBDL.Ritenuta,
        FEBDL.Natura,
        FEBDL.RiferimentoAmministrazione
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee FEBDL
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDL.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBDL
	
	FETCH NEXT FROM cursor_FEBDL INTO
		@NumeroLinea,
        @TipoCessionePrestazione,
        @Descrizione,
        @Quantita,
        @UnitaMisura,
        @DataInizioPeriodo,
        @DataFinePeriodo,
        @PrezzoUnitario,
        @PrezzoTotale,
        @AliquotaIVA,
        @Ritenuta,
        @Natura,
        @RiferimentoAmministrazione;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.1', @TipoValore = 'I', @ValoreIntero = @NumeroLinea, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.2', @ValoreTesto = @TipoCessionePrestazione, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.4', @ValoreTesto = @Descrizione, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.5', @TipoValore = 'D', @ValoreDecimale = @Quantita, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.6', @ValoreTesto = @UnitaMisura, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.7', @TipoValore = 'E', @ValoreData = @DataInizioPeriodo, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.8', @TipoValore = 'E', @ValoreData = @DataFinePeriodo, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.9', @TipoValore = 'D', @ValoreDecimale = @PrezzoUnitario, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.11', @TipoValore = 'D', @ValoreDecimale = @PrezzoTotale, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.12', @TipoValore = 'D', @ValoreDecimale = @AliquotaIVA, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.13', @ValoreTesto = @Ritenuta, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.14', @ValoreTesto = @Natura, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.15', @ValoreTesto = @RiferimentoAmministrazione, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		
		-- TODO: verifica calcolo prezzo totale (elenco controlli versione 1.2)

		IF (@AliquotaIVA > 0.0 AND @AliquotaIVA < 1.0)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.1.12',
																@CodiceErroreSDI = 424,
																@valoreDecimale = @AliquotaIVA,
																@LivelloLog = 4;

		END;

		-- 2.1.1.13 Ritenuta: duplicato di controllo 2.1.1.5

		IF (@Natura = '' AND @AliquotaIVA = 0.0)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.1.14',
																@CodiceErroreSDI = 400,
																@valoreTesto = @Natura,
																@LivelloLog = 4;

		END;

		IF (@Natura <> '' AND @AliquotaIVA <> 0.0)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.1.14',
																@CodiceErroreSDI = 401,
																@valoreTesto = @Natura,
																@LivelloLog = 4;

		END;

		SELECT @IsNaturaObsoleta = IsObsoleta FROM XMLCodifiche.Natura WHERE IDNatura = @Natura;
        IF (@IsNaturaObsoleta = CAST(1 AS BIT))
        BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.1.14',
																@CodiceErroreSDI = 448,
																@valoreTesto = @Natura,
																@LivelloLog = 4;

        END;

		FETCH NEXT FROM cursor_FEBDL INTO
			@NumeroLinea,
			@TipoCessionePrestazione,
			@Descrizione,
			@Quantita,
			@UnitaMisura,
			@DataInizioPeriodo,
			@DataFinePeriodo,
			@PrezzoUnitario,
			@PrezzoTotale,
			@AliquotaIVA,
			@Ritenuta,
			@Natura,
			@RiferimentoAmministrazione;
	END
	
	CLOSE cursor_FEBDL
	DEALLOCATE cursor_FEBDL

	/*** DettaglioLinee: fine ***/

	/*** DettaglioLinee_CodiceArticolo: inizio ***/

	/* declare variables */
    DECLARE @CodiceArticolo_CodiceTipo NVARCHAR(35);
    DECLARE @CodiceArticolo_CodiceValore NVARCHAR(35);
	
	DECLARE cursor_FEBDLCA CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDLCA.CodiceArticolo_CodiceTipo,
        FEBDLCA.CodiceArticolo_CodiceValore
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee_CodiceArticolo FEBDLCA
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee FEBDL ON FEBDL.PKStaging_FatturaElettronicaBody_DettaglioLinee = FEBDLCA.PKStaging_FatturaElettronicaBody_DettaglioLinee
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDL.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBDLCA
	
	FETCH NEXT FROM cursor_FEBDLCA INTO @CodiceArticolo_CodiceTipo, @CodiceArticolo_CodiceValore;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.3.1', @ValoreTesto = @CodiceArticolo_CodiceTipo, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.3.2', @ValoreTesto = @CodiceArticolo_CodiceValore, @NumeroLinea = @NumeroLinea;
	
		FETCH NEXT FROM cursor_FEBDLCA INTO @CodiceArticolo_CodiceTipo, @CodiceArticolo_CodiceValore;
	END
	
	CLOSE cursor_FEBDLCA
	DEALLOCATE cursor_FEBDLCA

	/*** DettaglioLinee_CodiceArticolo: fine ***/

	/*** DettaglioLinee_ScontoMaggiorazione: inizio ***/

	/* declare variables */
    DECLARE @ScontoMaggiorazione_Tipo CHAR(2);
    DECLARE @ScontoMaggiorazione_Percentuale DECIMAL(5, 2);
    DECLARE @ScontoMaggiorazione_Importo DECIMAL(14, 2);
	
	DECLARE cursor_FEBDLSM CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDLCA.ScontoMaggiorazione_Tipo,
        FEBDLCA.ScontoMaggiorazione_Percentuale,
        FEBDLCA.ScontoMaggiorazione_Importo
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee_ScontoMaggiorazione FEBDLCA
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee FEBDL ON FEBDL.PKStaging_FatturaElettronicaBody_DettaglioLinee = FEBDLCA.PKStaging_FatturaElettronicaBody_DettaglioLinee
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDL.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBDLSM
	
	FETCH NEXT FROM cursor_FEBDLSM INTO @ScontoMaggiorazione_Tipo, @ScontoMaggiorazione_Percentuale, @ScontoMaggiorazione_Importo;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.10.1', @ValoreTesto = @ScontoMaggiorazione_Tipo, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.10.2', @TipoValore = 'D', @ValoreDecimale = @ScontoMaggiorazione_Percentuale, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.1.10.3', @TipoValore = 'D', @ValoreDecimale = @ScontoMaggiorazione_Importo, @IsObbligatorio = 0, @NumeroLinea = @NumeroLinea;

		IF (
			COALESCE(@ScontoMaggiorazione_Tipo, N'') <> N''
			AND COALESCE(@ScontoMaggiorazione_Percentuale, 0.0) = 0.0
			AND COALESCE(@ScontoMaggiorazione_Importo, 0.0) = 0.0
		)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.1.10.1',
																@CodiceErroreSDI = 438,
																@valoreTesto = @ScontoMaggiorazione_Tipo,
																@LivelloLog = 4;

		END;

		FETCH NEXT FROM cursor_FEBDLSM INTO @ScontoMaggiorazione_Tipo, @ScontoMaggiorazione_Percentuale, @ScontoMaggiorazione_Importo;
	END
	
	CLOSE cursor_FEBDLSM
	DEALLOCATE cursor_FEBDLSM

	/*** DettaglioLinee_ScontoMaggiorazione: fine ***/

	/*** DatiRiepilogo: inizio ***/

	DECLARE @AliquoteMancanti INT;

	WITH AliquoteIVA
	AS (
		SELECT DISTINCT
			FEBDL.AliquotaIVA

		FROM XMLFatture.Staging_FatturaElettronicaBody_DettaglioLinee FEBDL
		INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDL.PKStaging_FatturaElettronicaBody
			AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader

		UNION

		SELECT DISTINCT
			FEBDCP.AliquotaIVA

		FROM XMLFatture.Staging_FatturaElettronicaBody_DatiCassaPrevidenziale FEBDCP
		INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDCP.PKStaging_FatturaElettronicaBody
			AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader
	)
	SELECT @AliquoteMancanti = COUNT(1)
	FROM AliquoteIVA AIVA
	LEFT JOIN (
		SELECT DISTINCT
			FEBDR.AliquotaIVA

		FROM XMLFatture.Staging_FatturaElettronicaBody_DatiRiepilogo FEBDR
		INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDR.PKStaging_FatturaElettronicaBody
			AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader
	) DR ON DR.AliquotaIVA = AIVA.AliquotaIVA
	WHERE DR.AliquotaIVA IS NULL;

	IF (@AliquoteMancanti > 0)
	BEGIN

		EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
															@IDCampo = N'2.2.2',
															@CodiceErroreSDI = 419,
															@valoreDecimale = @AliquoteMancanti,
															@LivelloLog = 4;

	END;

	/* declare variables */
	--DECLARE @AliquotaIVA DECIMAL(5, 2);
	--DECLARE @Natura VARCHAR(5);
	DECLARE @SpeseAccessorie DECIMAL(14, 2);
	DECLARE @Arrotondamento DECIMAL(20, 2);
	DECLARE @ImponibileImporto DECIMAL(14, 2);
	DECLARE @Imposta DECIMAL(14, 2);
	DECLARE @EsigibilitaIVA CHAR(1);
	DECLARE @RiferimentoNormativo NVARCHAR(100);
	
	DECLARE cursor_FEBDR CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDR.AliquotaIVA,
        FEBDR.Natura,
        FEBDR.SpeseAccessorie,
        FEBDR.Arrotondamento,
        FEBDR.ImponibileImporto,
        FEBDR.Imposta,
        FEBDR.EsigibilitaIVA,
        FEBDR.RiferimentoNormativo
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DatiRiepilogo FEBDR
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDR.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader
		AND FEBDR.ImponibileImporto > 0.0;
	
	OPEN cursor_FEBDR
	
	FETCH NEXT FROM cursor_FEBDR INTO
		@AliquotaIVA,
		@Natura,
		@SpeseAccessorie,
		@Arrotondamento,
		@ImponibileImporto,
		@Imposta,
		@EsigibilitaIVA,
		@RiferimentoNormativo;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.1', @TipoValore = 'D', @ValoreDecimale = @AliquotaIVA, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.2', @ValoreTesto = @Natura, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.3', @TipoValore = 'D', @ValoreDecimale = @SpeseAccessorie, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.4', @TipoValore = 'D', @ValoreDecimale = @Arrotondamento, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.5', @TipoValore = 'D', @ValoreDecimale = @ImponibileImporto;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.6', @TipoValore = 'D', @ValoreDecimale = @Imposta, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.7', @ValoreTesto = @EsigibilitaIVA, @IsObbligatorio = 1;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.2.2.8', @ValoreTesto = @RiferimentoNormativo, @IsObbligatorio = 0;

		IF (@AliquotaIVA > 0.0 AND @AliquotaIVA < 1.0)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.2.1',
																@CodiceErroreSDI = 424,
																@valoreDecimale = @AliquotaIVA,
																@LivelloLog = 4;

		END;

		IF (LEFT(@Natura, 2) = 'N6' AND @EsigibilitaIVA = 'S')
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.2.2',
																@CodiceErroreSDI = 420,
																@valoreTesto = @Natura,
																@LivelloLog = 4;

		END;

		IF (@Natura = '' AND @AliquotaIVA = 0.0)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.2.2',
																@CodiceErroreSDI = 429,
																@valoreTesto = @Natura,
																@LivelloLog = 4;

		END;

		IF (@Natura <> '' AND @AliquotaIVA <> 0.0)
		BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.2.2',
																@CodiceErroreSDI = 430,
																@valoreTesto = @Natura,
																@LivelloLog = 4;

		END;

		SELECT @IsNaturaObsoleta = IsObsoleta FROM XMLCodifiche.Natura WHERE IDNatura = @Natura;
        IF (@IsNaturaObsoleta = CAST(1 AS BIT))
        BEGIN

			EXEC XMLAudit.ssp_ScriviLogValidazioneDaErroreSDI @PKValidazione = @PKValidazione,
																@IDCampo = N'2.2.2.2',
																@CodiceErroreSDI = 448,
																@valoreTesto = @Natura,
																@LivelloLog = 4;

        END;

		FETCH NEXT FROM cursor_FEBDR INTO
			@AliquotaIVA,
			@Natura,
			@SpeseAccessorie,
			@Arrotondamento,
			@ImponibileImporto,
			@Imposta,
			@EsigibilitaIVA,
			@RiferimentoNormativo;
	END
	
	CLOSE cursor_FEBDR
	DEALLOCATE cursor_FEBDR

	/*** DatiRiepilogo: fine ***/

	/*** DatiPagamento: inizio ***/

	/* declare variables */
	DECLARE @CondizioniPagamento CHAR(4);
	
	DECLARE cursor_FEBDP CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDP.CondizioniPagamento
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DatiPagamento FEBDP
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDP.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBDP
	
	FETCH NEXT FROM cursor_FEBDP INTO @CondizioniPagamento;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.1', @ValoreTesto = @CondizioniPagamento;
	
	    FETCH NEXT FROM cursor_FEBDP INTO @CondizioniPagamento;
	END
	
	CLOSE cursor_FEBDP
	DEALLOCATE cursor_FEBDP

	/*** DatiPagamento: fine ***/

	/*** DatiPagamento_DettaglioPagamento: inizio ***/

	/* declare variables */
	DECLARE @Beneficiario NVARCHAR(200);
	DECLARE @ModalitaPagamento CHAR(4);
	DECLARE @DataRiferimentoTerminiPagamento DATE;
	DECLARE @GiorniTerminiPagamento INT;
	DECLARE @DataScadenzaPagamento DATE;
	DECLARE @ImportoPagamento DECIMAL(14, 2);
	DECLARE @CodUfficioPostale NVARCHAR(20);
	DECLARE @CognomeQuietanzante NVARCHAR(60);
	DECLARE @NomeQuietanzante NVARCHAR(60);
	DECLARE @CFQuietanzante NVARCHAR(16);
	DECLARE @TitoloQuietanzante NVARCHAR(10);
	DECLARE @IstitutoFinanziario NVARCHAR(80);
	DECLARE @IBAN NVARCHAR(34);
	DECLARE @ABI INT;
	DECLARE @CAB INT;
	DECLARE @BIC NVARCHAR(11);
	DECLARE @ScontoPagamentoAnticipato DECIMAL(14, 2);
	DECLARE @DataLimitePagamentoAnticipato DATE;
	DECLARE @PenalitaPagamentiRitardati DECIMAL(14, 2);
	DECLARE @DataDecorrenzaPenale DATE;
	DECLARE @CodicePagamento NVARCHAR(60);
	
	DECLARE cursor_FEBDPDP CURSOR FAST_FORWARD READ_ONLY FOR
	SELECT
        FEBDPDP.Beneficiario,
        FEBDPDP.ModalitaPagamento,
        FEBDPDP.DataRiferimentoTerminiPagamento,
        FEBDPDP.GiorniTerminiPagamento,
        FEBDPDP.DataScadenzaPagamento,
        FEBDPDP.ImportoPagamento,
        FEBDPDP.CodUfficioPostale,
        FEBDPDP.CognomeQuietanzante,
        FEBDPDP.NomeQuietanzante,
        FEBDPDP.CFQuietanzante,
        FEBDPDP.TitoloQuietanzante,
        FEBDPDP.IstitutoFinanziario,
        FEBDPDP.IBAN,
        FEBDPDP.ABI,
        FEBDPDP.CAB,
        FEBDPDP.BIC,
        FEBDPDP.ScontoPagamentoAnticipato,
        FEBDPDP.DataLimitePagamentoAnticipato,
        FEBDPDP.PenalitaPagamentiRitardati,
        FEBDPDP.DataDecorrenzaPenale,
        FEBDPDP.CodicePagamento
	
	FROM XMLFatture.Staging_FatturaElettronicaBody_DatiPagamento_DettaglioPagamento FEBDPDP
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody_DatiPagamento FEBDP ON FEBDP.PKStaging_FatturaElettronicaBody_DatiPagamento = FEBDPDP.PKStaging_FatturaElettronicaBody_DatiPagamento
	INNER JOIN XMLFatture.Staging_FatturaElettronicaBody FEB ON FEB.PKStaging_FatturaElettronicaBody = FEBDP.PKStaging_FatturaElettronicaBody
		AND FEB.PKStaging_FatturaElettronicaHeader = @PKStaging_FatturaElettronicaHeader;
	
	OPEN cursor_FEBDPDP
	
	FETCH NEXT FROM cursor_FEBDPDP INTO
		@Beneficiario,
		@ModalitaPagamento,
		@DataRiferimentoTerminiPagamento,
		@GiorniTerminiPagamento,
		@DataScadenzaPagamento,
		@ImportoPagamento,
		@CodUfficioPostale,
		@CognomeQuietanzante,
		@NomeQuietanzante,
		@CFQuietanzante,
		@TitoloQuietanzante,
		@IstitutoFinanziario,
		@IBAN,
		@ABI,
		@CAB,
		@BIC,
		@ScontoPagamentoAnticipato,
		@DataLimitePagamentoAnticipato,
		@PenalitaPagamentiRitardati,
		@DataDecorrenzaPenale,
		@CodicePagamento;
	
	WHILE @@FETCH_STATUS = 0
	BEGIN
	    
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.1', @ValoreTesto = @Beneficiario, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.2', @ValoreTesto = @ModalitaPagamento, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.3', @TipoValore = 'E', @ValoreData = @DataRiferimentoTerminiPagamento, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.4', @TipoValore = 'I', @ValoreIntero = @GiorniTerminiPagamento, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.5', @TipoValore = 'E', @ValoreData = @DataScadenzaPagamento, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.6', @TipoValore = 'D', @ValoreDecimale = @ImportoPagamento;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.7', @ValoreTesto = @CodUfficioPostale, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.8', @ValoreTesto = @CognomeQuietanzante, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.9', @ValoreTesto = @NomeQuietanzante, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.10', @ValoreTesto = @CFQuietanzante, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.11', @ValoreTesto = @TitoloQuietanzante, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.12', @ValoreTesto = @IstitutoFinanziario, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.13', @ValoreTesto = @IBAN, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.14', @TipoValore = 'I', @ValoreIntero = @ABI, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.15', @TipoValore = 'I', @ValoreIntero = @CAB, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.16', @ValoreTesto = @BIC, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.17', @TipoValore = 'D', @ValoreDecimale = @ScontoPagamentoAnticipato, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.18', @TipoValore = 'E', @ValoreData = @DataLimitePagamentoAnticipato, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.19', @TipoValore = 'D', @ValoreDecimale = @PenalitaPagamentiRitardati, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.20', @TipoValore = 'E', @ValoreData = @DataDecorrenzaPenale, @IsObbligatorio = 0;
		EXEC XMLFatture.ssp_VerificaCampoSDI @PKValidazione = @PKValidazione, @IDCampo = N'2.4.2.21', @ValoreTesto = @CodicePagamento, @IsObbligatorio = 0;

		FETCH NEXT FROM cursor_FEBDPDP INTO
			@Beneficiario,
			@ModalitaPagamento,
			@DataRiferimentoTerminiPagamento,
			@GiorniTerminiPagamento,
			@DataScadenzaPagamento,
			@ImportoPagamento,
			@CodUfficioPostale,
			@CognomeQuietanzante,
			@NomeQuietanzante,
			@CFQuietanzante,
			@TitoloQuietanzante,
			@IstitutoFinanziario,
			@IBAN,
			@ABI,
			@CAB,
			@BIC,
			@ScontoPagamentoAnticipato,
			@DataLimitePagamentoAnticipato,
			@PenalitaPagamentiRitardati,
			@DataDecorrenzaPenale,
			@CodicePagamento;
	END
	
	CLOSE cursor_FEBDPDP
	DEALLOCATE cursor_FEBDPDP

	/*** DatiPagamento_DettaglioPagamento: fine ***/

	CLOSE cursor_FEB;
	DEALLOCATE cursor_FEB;

END;
GO
